/**
 * Vulnerability Detection / Adaptive Delivery Engine
 *
 * Detects emotional state from user messages and adapts delivery mode
 * without altering truth content. Feeds into qualia channels when available.
 *
 * Additive only. Silent failure. No existing logic changes.
 */

// ── Keyword Dictionaries ────────────────────────────────────────────────────

const FRAGILE_KEYWORDS = [
  "i feel hopeless", "suicidal", "kill myself", "i can't go on",
  "panic attack", "can't breathe", "want to die", "end it all",
  "no reason to live", "better off dead", "nobody cares",
];

const DISTRESSED_KEYWORDS = [
  "anxious", "stressed", "depressed", "sad", "lonely", "lost",
  "overwhelmed", "scared", "afraid", "angry", "frustrated",
  "exhausted", "burned out", "falling apart", "hopeless",
  "worthless", "ashamed", "guilty", "panicking", "drowning",
  "struggling", "suffering", "miserable", "desperate",
];

const POSITIVE_KEYWORDS = [
  "happy", "excited", "great", "amazing", "grateful",
  "accomplished", "proud", "hopeful", "motivated",
  "inspired", "thriving", "confident", "peaceful", "joyful",
];

// ── Core Detection ──────────────────────────────────────────────────────────

/**
 * Assess emotional vulnerability from a user message.
 *
 * @param {string} message - User's raw message text
 * @returns {{ level: string, score: number, triggers: string[], requiresEscalation: boolean }}
 */
export function detectVulnerability(message) {
  const lower = String(message || "").toLowerCase();

  // Check fragile (high vulnerability)
  const fragileMatches = FRAGILE_KEYWORDS.filter(k => lower.includes(k));
  if (fragileMatches.length > 0) {
    return {
      level: "high",
      score: 0.9,
      triggers: fragileMatches,
      requiresEscalation: true,
    };
  }

  // Check distressed (medium vulnerability)
  const distressedMatches = DISTRESSED_KEYWORDS.filter(k => lower.includes(k));
  if (distressedMatches.length > 0) {
    return {
      level: "medium",
      score: Math.min(0.8, 0.3 + distressedMatches.length * 0.1),
      triggers: distressedMatches,
      requiresEscalation: false,
    };
  }

  // Check positive
  const positiveMatches = POSITIVE_KEYWORDS.filter(k => lower.includes(k));
  if (positiveMatches.length > 0) {
    return {
      level: "positive",
      score: 0.1,
      triggers: positiveMatches,
      requiresEscalation: false,
    };
  }

  return {
    level: "low",
    score: 0.2,
    triggers: [],
    requiresEscalation: false,
  };
}

// ── Delivery Mode Selection ─────────────────────────────────────────────────

/**
 * Choose delivery mode based on vulnerability assessment.
 * Maps to qualia channels: delivery_os.directness, delivery_os.detail_density
 *
 * @param {{ level: string, score: number }} vulnerability
 * @returns {{ mode: string, directness: number, buffering: number, detailDensity: number, policy: string }}
 */
export function chooseDeliveryMode(vulnerability) {
  switch (vulnerability.level) {
    case "high":
      return {
        mode: "gentle",
        directness: 0.3,
        buffering: 0.9,
        detailDensity: 0.4,
        policy: "Truth mandatory. Maximum emotional cushioning. Suggest resources. Never alter facts.",
      };
    case "medium":
      return {
        mode: "dual",
        directness: 0.5,
        buffering: 0.6,
        detailDensity: 0.6,
        policy: "Present multiple perspectives. Acknowledge difficulty. Stay truthful.",
      };
    case "positive":
      return {
        mode: "direct",
        directness: 0.8,
        buffering: 0.2,
        detailDensity: 0.8,
        policy: "Match energy. Full directness. High detail.",
      };
    default:
      return {
        mode: "direct",
        directness: 0.7,
        buffering: 0.3,
        detailDensity: 0.7,
        policy: "Standard delivery. Truth-forward.",
      };
  }
}

// ── Qualia Integration ──────────────────────────────────────────────────────

/**
 * Feed vulnerability assessment into qualia channels.
 *
 * @param {string} entityId
 * @param {{ level: string, score: number, requiresEscalation: boolean }} vulnerability
 * @param {{ directness: number, buffering: number, detailDensity: number }} deliveryMode
 */
export function hookVulnerability(entityId, vulnerability, deliveryMode) {
  const engine = globalThis.qualiaEngine;
  if (!engine || !entityId) return;

  engine.batchUpdate(entityId, {
    "emotional_resonance_os.distress_level": vulnerability.score,
    "delivery_os.directness": deliveryMode.directness,
    "delivery_os.detail_density": deliveryMode.detailDensity,
    "trauma_aware_os.sensitivity_level": vulnerability.score,
    "trauma_aware_os.overwhelm_risk": vulnerability.level === "high" ? 0.9 : vulnerability.score * 0.5,
    "trauma_aware_os.trigger_proximity": vulnerability.requiresEscalation ? 0.95 : 0.1,
  });
}

/**
 * Full pipeline: detect → choose delivery → feed qualia → return result.
 *
 * @param {string} message - User message
 * @param {string} [entityId] - Entity to update qualia for
 * @returns {{ vulnerability: object, delivery: object }}
 */
export function assessAndAdapt(message, entityId) {
  const vulnerability = detectVulnerability(message);
  const delivery = chooseDeliveryMode(vulnerability);

  if (entityId) {
    try { hookVulnerability(entityId, vulnerability, delivery); } catch { /* silent */ }
  }

  return { vulnerability, delivery };
}
